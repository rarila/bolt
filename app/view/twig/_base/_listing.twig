{# Variables available to custumn listings #}
{% set listing = {
    compact:        compact|default(false),
    content:        content,
    permissions:    permissions|default({
                        create:    permissions.create|default(false),
                        edit:      permissions.edit|default(false),
                        delete:    permissions.delete|default(false),
                        publish:   permissions.publish|default(false),
                        depublish: permissions.depublish|default(false),
                    }),
    excerptlength:  excerptlength,
    thumbsize:      thumbsize,
}%}

{% set modifiable = listing.permissions.create or
                    listing.permissions.edit or
                    listing.permissions.delete or
                    listing.permissions.publish or
                    listing.permissions.depublish %}

{% set prop = {
    has_groupname:  listing.content.group.name is defined,
    nextgroup:      new_group|default(false),
    unordered:      request('order') == '',
    first:          loop.first,
    last:           loop.last|default(loop.first)
}%}

{% set local = {
    row_heading:    not listing.compact and prop.unordered and prop.has_groupname and (prop.first or prop.nextgroup),
    row_header:     not listing.compact and (prop.first or (prop.has_groupname and prop.nextgroup) and prop.unordered),

} %}
{% set local_columns = not listing.compact and modifiable ? ['[X]'] : [] %}

{# Build columns #}
{% for colum in block('listing_columns')|default('Id,Content,Thumbnail,(Meta),Actions')|lower|split(',') %}
    {% set colname = colum|trim('()') %}
    {% if not listing.compact or colum == colname %}
        {% set local_columns = local_columns|merge([colname]) %}
    {% endif %}
{% endfor %}

{#
 # Macros
 #}

{% macro tbody_beg(local, modifiable) %}
    {% set class = [
        modifiable ? 'sortable' : '',
        local.row_heading and local.row_header ? 'striping_even' : 'striping_odd',
    ] %}

    <tbody{{ hclass(class)}}>
{% endmacro %}

{% macro tbody_end(toolbar) %}
    {% if toolbar %}
        <tr class="selectiontoolbar hidden">
            <td colspan="{{ block('listing_columns') }}">
                <i class="fa fa-fw fa-rotate-270 fa-mail-forward"></i><div class="count">0</div>
                {{ toolbar }}
            </td>
        </tr>
    {% endif %}
    </tbody>
{% endmacro %}

{% import '@bolt/_sub/_record-listing-select.twig' as column_select %}
{% import '@bolt/_sub/_record-listing-id.twig' as column_id %}
{% import '@bolt/_sub/_record-listing-content.twig' as column_content %}
{% import '@bolt/_sub/_record-listing-thumbnail.twig' as column_thumbnail %}
{% import '@bolt/_sub/_record-listing-meta.twig' as column_meta %}
{% import '@bolt/_sub/_record-listing-actions.twig' as column_actions %}

{#
 # GROUPNAME: If we have 'grouping', print the row with the groupname.
 #}
{% from _self import tbody_beg, tbody_end %}

{% if local.row_heading or internal.heading|default() %}

    {% if not prop.first %}
        {{ tbody_end(internal.selection_toolbar|default()) }}
    {% endif %}

    {{ tbody_beg(local, modifiable) }}

    <tr class="heading">
        <th colspan="{{ local_columns|length }}">
            {% if internal.heading|default() %}
                {{ internal.heading }}
            {% else %}
                {{ listing.content.group.name|default(__('(no group)')) }}
            {% endif %}
        </th>
    </tr>
{% elseif prop.first %}
    {{ tbody_beg(local, modifiable) }}
{% endif %}

{#
 # HEADER ROW: Print the header for the first row.
 #}
{% if local.row_header %}
    {# Deprecated #}
    {% set params = {} %}
    {% for key, val in app.request.query.all if key != 'order' %}
        {% set params = params|merge({(key): val}) %}
    {% endfor %}
    {% set link = '?' ~ params|url_encode ~ (params|length ? '&' : '') ~ 'order=' %}
    {# /Deprecated #}

    <tr class="header">
        {% from '@bolt/_buic/_listing.twig' import buic_listing_slink %}

        {# Output header columns #}
        {% for colname in local_columns %}
            {% set block_hcol = block('listing_hcol_' ~ colname)|default(false) %}

            {% if block_hcol is not same as(false) %}
                {{ block_hcol|raw }}

            {% elseif colname == '[X]' %}
                {{ column_select.head() }}

            {% elseif colname == 'id' %}
                {{ column_id.head() }}

            {% elseif colname == 'content' %}
                {{ column_content.head(listing, modifiable) }}

            {% elseif colname == 'thumbnail' %}
                {{ column_thumbnail.head() }}

            {% elseif colname == 'meta' %}
                {{ column_meta.head() }}

            {% elseif colname == 'actions' %}
                {{ column.head_actions(listing, modifiable) }}

            {% else %}
                <th><del>{{colname }}</del></th>
            {% endif %}
        {% endfor %}
    </tr>
{% endif %}

{#
 # DATA ROW
 #}

<tr {% if listing.content.status != 'published' %}class="dim"{% endif %}{% if not listing.compact and modifiable %} id="item_{{ listing.content.id }}"{% endif %}>
    {% for colname in local_columns %}
        {% set block_hcol = block('listing_dcol_' ~ colname)|default(false) %}

        {% if block_hcol is not same as(false) %}
            {{ block_hcol|raw }}

        {% elseif colname == '[X]' %}
            {{ column_select.data() }}

        {% elseif colname == 'id' %}
            {{ column_id.data(listing) }}

        {% elseif colname == 'content' %}
            {{ column_content.data(listing, modifiable) }}

        {% elseif colname == 'thumbnail' %}
            {{ column_thumbnail.data(listing) }}

        {% elseif colname == 'meta' %}
            {{ column_meta.data(listing) }}

        {% elseif colname == 'actions' %}
            {{ column_actions.data(listing, modifiable) }}

        {% else %}
            <td><del>{{colname }}</del></td>
        {% endif %}
    {% endfor %}
</tr>

{% if prop.last %}
    {{ tbody_end(internal.selection_toolbar|default()) }}
{% endif %}
